ersion: 2.1

jobs:
  build:
    docker:
      # Use a base image with JDK
      - image: cimg/openjdk:25.0.0 # Use an appropriate OpenJDK version
    working_directory: ~/project

    steps:
      - checkout
      
      # Restore cached Maven dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}

      # Install dependencies and compile
      - run: mvn dependency:go-offline
      
      # Save dependencies cache
      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

      # Step 2: Make the script executable (if not already)
      - run:
          name: Make script executable
          command: chmod +x run.sh

      # Run tests using Maven's test or integration-test goal
      - run:
          name: Run Selenium TestNG Tests and send email
          command: ./run.sh
          
      # Ensure test results are saved for CircleCI Insights
      - run:
          name: Save test results
          command: |
            mkdir -p ~/project/test-results/testng/
            # Copy TestNG results (usually surefire-reports or test-output) to a consistent location
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/project/test-results/testng/ \;
          when: always # Ensures this step runs even if tests fail

      # Store test results as a CircleCI artifact
      - store_test_results:
          path: ~/project/test-results/testng/

      # Store artifacts (e.g., emailable reports, screenshots)
      - store_artifacts:
          path: ~/project/test-results/testng/

workflows:
  version: 2
  build_and_test:
    jobs:
      - build